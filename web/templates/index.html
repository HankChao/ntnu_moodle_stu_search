<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸«å¤§å­¸ç”Ÿè³‡æ–™æœå°‹ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .student-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }
        .search-form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .badge-custom {
            font-size: 0.8em;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">ğŸ“ å¸«å¤§å­¸ç”Ÿè³‡æ–™æœå°‹ç³»çµ±</h1>
        
        <!-- æœå°‹è¡¨å–® -->
        <div class="search-form">
            <form method="POST" action="/search">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="search_term" class="form-label">é—œéµå­—æœå°‹ï¼ˆå§“åæˆ–å­¸è™Ÿï¼‰</label>
                        <input type="text" class="form-control" id="search_term" name="search_term" 
                               placeholder="è«‹è¼¸å…¥å§“åæˆ–å­¸è™Ÿ">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="education" class="form-label">å­¸åˆ¶</label>
                        <select class="form-select" id="education" name="education">
                            <option value="">å…¨éƒ¨</option>
                            {% for edu in filter_options.educations %}
                            <option value="{{ edu }}">{{ edu }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="admission_year" class="form-label">å…¥å­¸å¹´åº¦</label>
                        <input type="text" class="form-control" id="admission_year" name="admission_year" placeholder="{{ filter_options.admission_year_placeholder }}">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="college" class="form-label">å­¸é™¢</label>
                        <select class="form-select" id="college" name="college">
                            <option value="">å…¨éƒ¨</option>
                            {% for col in filter_options.colleges %}
                            <option value="{{ col }}">{{ col }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="department" class="form-label">ç³»æ‰€</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">å…¨éƒ¨</option>
                            {% for dept in filter_options.departments %}
                            <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">ğŸ” æœå°‹</button>
                    <button type="reset" class="btn btn-secondary btn-lg ms-2">ğŸ—‘ï¸ æ¸…é™¤</button>
                </div>
            </form>
        </div>
        
        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="alert alert-info">
            <strong>è³‡æ–™åº«çµ±è¨ˆï¼š</strong>ç¸½å…±æœ‰ {{ total_count }} ç­†å­¸ç”Ÿè³‡æ–™
            {% set suspicious_count = students | selectattr('is_suspicious', 'equalto', true) | list | length %}
            {% if suspicious_count > 0 %}
            <br><small class="text-warning">âš ï¸ å…¶ä¸­ {{ suspicious_count }} ç­†ç‚ºç–‘ä¼¼å•é¡Œè³‡æ–™</small>
            {% endif %}
        </div>
        
        <!-- å­¸ç”Ÿåˆ—è¡¨ (ç”± JS å‹•æ…‹æ¸²æŸ“) -->
        <h3 id="student-list-title">æœ€æ–°å­¸ç”Ÿè³‡æ–™ (å‰100ç­†)</h3>
        <div id="student-list" class="row"></div>
        <!-- åˆ†é æŒ‰éˆ• -->
        <nav>
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
        <!-- è·³é è¼¸å…¥æ¡† -->
        <div class="d-flex justify-content-center align-items-center my-2">
            <label for="goto-page-input" class="me-2 mb-0">è·³è‡³ç¬¬</label>
            <input type="number" min="1" id="goto-page-input" style="width: 70px;" class="form-control form-control-sm d-inline-block me-2" />
            <span class="me-2">é </span>
            <button id="goto-page-btn" class="btn btn-sm btn-outline-primary">å‰å¾€</button>
        </div>
    </div>

</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const pageSize = 100;
let currentPage = 1;
let totalCount = 0;
let lastQuery = {};

function getFormQuery() {
    return {
        search_term: document.getElementById('search_term').value.trim(),
        education: document.getElementById('education').value,
        admission_year: document.getElementById('admission_year').value.trim(),
        college: document.getElementById('college').value,
        department: document.getElementById('department').value
    };
}

function renderStudents(students) {
    const list = document.getElementById('student-list');
    list.innerHTML = '';
    if (!students.length) {
        list.innerHTML = '<div class="alert alert-warning text-center">ğŸ˜• æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿè³‡æ–™</div>';
        return;
    }
    for (const student of students) {
        let suspicious = student.is_suspicious ? `<span class="badge bg-warning text-dark ms-1" title="ç–‘ä¼¼å•é¡Œï¼š${(student.suspicious_reasons||[]).join(', ')}">âš ï¸ ç–‘ä¼¼</span>` : '';
        let isError = student.error !== undefined && student.error !== null && student.error !== '';
        // å¦‚æœ error å­˜åœ¨ï¼Œæ‰€æœ‰æ¬„ä½éƒ½é¡¯ç¤ºæœªçŸ¥
        let studentId = isError ? 'æœªçŸ¥' : (student.student_id || 'æœªçŸ¥');
        let admissionYear = isError ? 'æœªçŸ¥' : (student.admission_year || 'æœªçŸ¥');
        let collegeName = isError ? 'æœªçŸ¥' : (student.college_name && student.college_name.includes('/') ? student.college_name.split('/')[1] : (student.college_name||'æœªçŸ¥'));
        let deptName = isError ? 'æœªçŸ¥' : (student.department_name && student.department_name.includes('/') ? student.department_name.split('/')[1] : (student.department_name||'æœªçŸ¥'));
        // ä¸é¡¯ç¤ºç­ç´š
        let classCode = '';
        let badges = studentId !== 'æœªçŸ¥' ? `<span class="badge bg-primary badge-custom">${studentId}</span> <span class="badge bg-success badge-custom">${student.education||''}</span>` : '<span class="badge bg-warning">ç„¡å­¸è™Ÿè³‡è¨Š</span>';
        let info = `<div class="mb-2">${badges}</div>
            <div class="small text-muted">
                <div>ğŸ“… å…¥å­¸ï¼šæ°‘åœ‹${admissionYear}å¹´</div>
                <div>ğŸ« ${collegeName}</div>
                <div>ğŸ“š ${deptName}</div>
                ${classCode}
            </div>`;
        // åªæœ‰å…¨éƒ¨ç‚ºæœªçŸ¥æ™‚æ‰é¡¯ç¤ºè³‡æ–™ç•°å¸¸
        let errorInfo = '';
        if (isError && studentId === 'æœªçŸ¥' && admissionYear === 'æœªçŸ¥' && collegeName === 'æœªçŸ¥' && deptName === 'æœªçŸ¥') {
            errorInfo = `<div class="alert alert-warning p-2 mb-1">âš ï¸ ${student.error||'è³‡æ–™ç•°å¸¸'}</div>`;
        }
        list.innerHTML += `
        <div class="col-md-6 col-lg-4">
            <div class="student-card">
                <div class="d-flex align-items-center mb-2">
                    <img src="${student.avatar_url||''}" alt="é ­åƒ" class="avatar me-3" onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
                    <div>
                        <h6 class="mb-1">${student.name||''}${suspicious}</h6>
                        <small class="text-muted">ID: ${student.id||''}</small>
                    </div>
                </div>
                ${info}
                ${errorInfo}
            </div>
        </div>`;
    }
}

function renderPagination(total, page) {
    const ul = document.getElementById('pagination');
    ul.innerHTML = '';
    const totalPages = Math.ceil(total / pageSize);
    if (totalPages <= 1) return;
    // ä¸Šä¸€é 
    ul.innerHTML += `<li class="page-item${page===1?' disabled':''}"><a class="page-link" href="#" data-page="${page-1}">ä¸Šä¸€é </a></li>`;
    // é ç¢¼
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || Math.abs(i-page)<=2) {
            ul.innerHTML += `<li class="page-item${i===page?' active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        } else if (i === page-3 || i === page+3) {
            ul.innerHTML += `<li class="page-item disabled"><span class="page-link">â€¦</span></li>`;
        }
    }
    // ä¸‹ä¸€é 
    ul.innerHTML += `<li class="page-item${page===totalPages?' disabled':''}"><a class="page-link" href="#" data-page="${page+1}">ä¸‹ä¸€é </a></li>`;
    // ç¶å®šåˆ†é æŒ‰éˆ•äº‹ä»¶
    ul.querySelectorAll('a.page-link').forEach(a => {
        a.addEventListener('click', function(e){
            e.preventDefault();
            const p = parseInt(this.dataset.page);
            if (p>=1 && p<=totalPages && p!==page) {
                gotoPage(p);
                window.scrollTo({top:0, behavior:'smooth'});
            }
        });
    });
    // è·³é åŠŸèƒ½ï¼ˆæ¯æ¬¡åˆ†é æ¸²æŸ“éƒ½è¦é‡æ–°ç¶å®šï¼‰
    const input = document.getElementById('goto-page-input');
    const btn = document.getElementById('goto-page-btn');
    if (input && btn) {
        btn.onclick = function() {
            const val = parseInt(input.value);
            if (!isNaN(val) && val >= 1 && val <= totalPages) {
                gotoPage(val);
                window.scrollTo({top:0, behavior:'smooth'});
            } else {
                input.value = '';
                input.placeholder = 'é ç¢¼éŒ¯èª¤';
            }
        };
        input.onkeydown = function(e) {
            if (e.key === 'Enter') {
                btn.click();
            }
        };
    }
}

function gotoPage(page) {
    const query = {...lastQuery, page, size: pageSize};
    fetch('/api/students?' + new URLSearchParams(query))
        .then(r=>r.json())
        .then(data=>{
            renderStudents(data.students);
            renderPagination(data.total_count, page);
            totalCount = data.total_count;
            currentPage = page;
            document.getElementById('student-list-title').textContent = `å­¸ç”Ÿè³‡æ–™ (ç¬¬${(page-1)*pageSize+1}~${Math.min(page*pageSize, totalCount)} / å…±${totalCount}ç­†)`;
        });
}

document.querySelector('.search-form form').addEventListener('submit', function(e){
    e.preventDefault();
    lastQuery = getFormQuery();
    gotoPage(1);
});

document.querySelector('.search-form form').addEventListener('reset', function(e){
    setTimeout(()=>{
        lastQuery = getFormQuery();
        gotoPage(1);
    }, 0);
});

// é é¢è¼‰å…¥è‡ªå‹•æŸ¥è©¢
window.addEventListener('DOMContentLoaded', ()=>{
    lastQuery = getFormQuery();
    gotoPage(1);
});
</script>
</body>
</html>
