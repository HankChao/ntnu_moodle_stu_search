<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>師大學生資料搜尋系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .student-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }
        .search-form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .badge-custom {
            font-size: 0.8em;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">🎓 師大學生資料搜尋系統</h1>
        
        <!-- 搜尋表單 -->
        <div class="search-form">
            <form method="POST" action="/search">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="search_term" class="form-label">關鍵字搜尋（姓名或學號）</label>
                        <input type="text" class="form-control" id="search_term" name="search_term" 
                               placeholder="請輸入姓名或學號">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="education" class="form-label">學制</label>
                        <select class="form-select" id="education" name="education">
                            <option value="">全部</option>
                            {% for edu in filter_options.educations %}
                            <option value="{{ edu }}">{{ edu }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="admission_year" class="form-label">入學年度</label>
                        <input type="text" class="form-control" id="admission_year" name="admission_year" placeholder="{{ filter_options.admission_year_placeholder }}">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="college" class="form-label">學院</label>
                        <select class="form-select" id="college" name="college">
                            <option value="">全部</option>
                            {% for col in filter_options.colleges %}
                            <option value="{{ col }}">{{ col }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="department" class="form-label">系所</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">全部</option>
                            {% for dept in filter_options.departments %}
                            <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">🔍 搜尋</button>
                    <button type="reset" class="btn btn-secondary btn-lg ms-2">🗑️ 清除</button>
                </div>
            </form>
        </div>
        
        <!-- 統計資訊 -->
        <div class="alert alert-info">
            <strong>資料庫統計：</strong>總共有 {{ total_count }} 筆學生資料
            {% set suspicious_count = students | selectattr('is_suspicious', 'equalto', true) | list | length %}
            {% if suspicious_count > 0 %}
            <br><small class="text-warning">⚠️ 其中 {{ suspicious_count }} 筆為疑似問題資料</small>
            {% endif %}
        </div>
        
        <!-- 學生列表 (由 JS 動態渲染) -->
        <h3 id="student-list-title">最新學生資料 (前100筆)</h3>
        <div id="student-list" class="row"></div>
        <!-- 分頁按鈕 -->
        <nav>
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
        <!-- 跳頁輸入框 -->
        <div class="d-flex justify-content-center align-items-center my-2">
            <label for="goto-page-input" class="me-2 mb-0">跳至第</label>
            <input type="number" min="1" id="goto-page-input" style="width: 70px;" class="form-control form-control-sm d-inline-block me-2" />
            <span class="me-2">頁</span>
            <button id="goto-page-btn" class="btn btn-sm btn-outline-primary">前往</button>
        </div>
    </div>

</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const pageSize = 100;
let currentPage = 1;
let totalCount = 0;
let lastQuery = {};

function getFormQuery() {
    return {
        search_term: document.getElementById('search_term').value.trim(),
        education: document.getElementById('education').value,
        admission_year: document.getElementById('admission_year').value.trim(),
        college: document.getElementById('college').value,
        department: document.getElementById('department').value
    };
}

function renderStudents(students) {
    const list = document.getElementById('student-list');
    list.innerHTML = '';
    if (!students.length) {
        list.innerHTML = '<div class="alert alert-warning text-center">😕 沒有找到符合條件的學生資料</div>';
        return;
    }
    for (const student of students) {
        let suspicious = student.is_suspicious ? `<span class="badge bg-warning text-dark ms-1" title="疑似問題：${(student.suspicious_reasons||[]).join(', ')}">⚠️ 疑似</span>` : '';
        let isError = student.error !== undefined && student.error !== null && student.error !== '';
        // 如果 error 存在，所有欄位都顯示未知
        let studentId = isError ? '未知' : (student.student_id || '未知');
        let admissionYear = isError ? '未知' : (student.admission_year || '未知');
        let collegeName = isError ? '未知' : (student.college_name && student.college_name.includes('/') ? student.college_name.split('/')[1] : (student.college_name||'未知'));
        let deptName = isError ? '未知' : (student.department_name && student.department_name.includes('/') ? student.department_name.split('/')[1] : (student.department_name||'未知'));
        // 不顯示班級
        let classCode = '';
        let badges = studentId !== '未知' ? `<span class="badge bg-primary badge-custom">${studentId}</span> <span class="badge bg-success badge-custom">${student.education||''}</span>` : '<span class="badge bg-warning">無學號資訊</span>';
        let info = `<div class="mb-2">${badges}</div>
            <div class="small text-muted">
                <div>📅 入學：民國${admissionYear}年</div>
                <div>🏫 ${collegeName}</div>
                <div>📚 ${deptName}</div>
                ${classCode}
            </div>`;
        // 只有全部為未知時才顯示資料異常
        let errorInfo = '';
        if (isError && studentId === '未知' && admissionYear === '未知' && collegeName === '未知' && deptName === '未知') {
            errorInfo = `<div class="alert alert-warning p-2 mb-1">⚠️ ${student.error||'資料異常'}</div>`;
        }
        list.innerHTML += `
        <div class="col-md-6 col-lg-4">
            <div class="student-card">
                <div class="d-flex align-items-center mb-2">
                    <img src="${student.avatar_url||''}" alt="頭像" class="avatar me-3" onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
                    <div>
                        <h6 class="mb-1">${student.name||''}${suspicious}</h6>
                        <small class="text-muted">ID: ${student.id||''}</small>
                    </div>
                </div>
                ${info}
                ${errorInfo}
            </div>
        </div>`;
    }
}

function renderPagination(total, page) {
    const ul = document.getElementById('pagination');
    ul.innerHTML = '';
    const totalPages = Math.ceil(total / pageSize);
    if (totalPages <= 1) return;
    // 上一頁
    ul.innerHTML += `<li class="page-item${page===1?' disabled':''}"><a class="page-link" href="#" data-page="${page-1}">上一頁</a></li>`;
    // 頁碼
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || Math.abs(i-page)<=2) {
            ul.innerHTML += `<li class="page-item${i===page?' active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        } else if (i === page-3 || i === page+3) {
            ul.innerHTML += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
        }
    }
    // 下一頁
    ul.innerHTML += `<li class="page-item${page===totalPages?' disabled':''}"><a class="page-link" href="#" data-page="${page+1}">下一頁</a></li>`;
    // 綁定分頁按鈕事件
    ul.querySelectorAll('a.page-link').forEach(a => {
        a.addEventListener('click', function(e){
            e.preventDefault();
            const p = parseInt(this.dataset.page);
            if (p>=1 && p<=totalPages && p!==page) {
                gotoPage(p);
                window.scrollTo({top:0, behavior:'smooth'});
            }
        });
    });
    // 跳頁功能（每次分頁渲染都要重新綁定）
    const input = document.getElementById('goto-page-input');
    const btn = document.getElementById('goto-page-btn');
    if (input && btn) {
        btn.onclick = function() {
            const val = parseInt(input.value);
            if (!isNaN(val) && val >= 1 && val <= totalPages) {
                gotoPage(val);
                window.scrollTo({top:0, behavior:'smooth'});
            } else {
                input.value = '';
                input.placeholder = '頁碼錯誤';
            }
        };
        input.onkeydown = function(e) {
            if (e.key === 'Enter') {
                btn.click();
            }
        };
    }
}

function gotoPage(page) {
    const query = {...lastQuery, page, size: pageSize};
    fetch('/api/students?' + new URLSearchParams(query))
        .then(r=>r.json())
        .then(data=>{
            renderStudents(data.students);
            renderPagination(data.total_count, page);
            totalCount = data.total_count;
            currentPage = page;
            document.getElementById('student-list-title').textContent = `學生資料 (第${(page-1)*pageSize+1}~${Math.min(page*pageSize, totalCount)} / 共${totalCount}筆)`;
        });
}

document.querySelector('.search-form form').addEventListener('submit', function(e){
    e.preventDefault();
    lastQuery = getFormQuery();
    gotoPage(1);
});

document.querySelector('.search-form form').addEventListener('reset', function(e){
    setTimeout(()=>{
        lastQuery = getFormQuery();
        gotoPage(1);
    }, 0);
});

// 頁面載入自動查詢
window.addEventListener('DOMContentLoaded', ()=>{
    lastQuery = getFormQuery();
    gotoPage(1);
});
</script>
</body>
</html>
